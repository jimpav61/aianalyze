import { jsPDF } from "jspdf";
import { DetailedFormData } from "@/types/analysis";

interface GenerateReportParams {
  formData: DetailedFormData;
  analysis: {
    industry: string;
    department: string;
    bot_function: string;
    savings: number;
    profit_increase: number;
    explanation: string;
    marketing_strategy: string;
    allAnalyses?: any[];
  };
}

export const generateAnalysisReport = ({ formData, analysis }: GenerateReportParams): jsPDF => {
  const doc = new jsPDF();
  let yPosition = 20;

  // Helper function to add section headers with brand colors
  const addSectionHeader = (text: string, y: number) => {
    doc.setFillColor(246, 82, 40); // Primary brand color #f65228
    doc.rect(20, y - 6, 170, 10, "F");
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(14);
    doc.text(text, 25, y);
    doc.setTextColor(0);
    return y + 15;
  };

  // Helper function for content blocks with background
  const addContentBlock = (content: string[], y: number, title?: string) => {
    doc.setFillColor(249, 250, 251); // Light gray background
    const lineHeight = 7;
    const contentHeight = (content.length + (title ? 1 : 0)) * lineHeight + 10;
    doc.rect(20, y - 5, 170, contentHeight, "F");
    
    let currentY = y;
    if (title) {
      doc.setFontSize(12);
      doc.setFont("helvetica", "bold");
      doc.text(title, 25, currentY);
      currentY += lineHeight;
    }
    
    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    content.forEach(line => {
      const lines = doc.splitTextToSize(line, 160);
      lines.forEach(splitLine => {
        doc.text(splitLine, 25, currentY);
        currentY += lineHeight;
      });
    });
    return currentY + 5;
  };

  // Page 1: Executive Summary
  yPosition = addSectionHeader("ChatSites AI Analysis Report", yPosition);
  
  // Company Information Block
  yPosition = addContentBlock([
    `Company: ${formData.companyName}`,
    `Industry: ${analysis.industry}`,
    `Contact: ${formData.email}`,
    `Phone: ${formData.phoneNumber}`,
    `Employees: ${formData.employees}`,
    `Annual Revenue: ${formData.revenue}`
  ], yPosition + 10, "Company Information");

  // Key Metrics Block
  yPosition = addContentBlock([
    `Projected Annual Savings: $${analysis.savings.toLocaleString()}`,
    `Projected Profit Increase: ${analysis.profit_increase}%`,
    `Primary Department: ${analysis.department}`,
    `Primary Function: ${analysis.bot_function}`
  ], yPosition + 10, "Key Metrics");

  // Page 2: Current Operations
  doc.addPage();
  yPosition = 20;
  yPosition = addSectionHeader("Current Operations Analysis", yPosition);

  // Operations Details Block
  yPosition = addContentBlock([
    `Service Channels: ${formData.serviceChannels}`,
    `Monthly Interactions: ${formData.monthlyInteractions}`,
    `Current Tools: ${formData.currentTools}`,
    `Pain Points: ${formData.painPoints}`
  ], yPosition + 10, "Operations Overview");

  // Implementation Strategy Block
  yPosition = addContentBlock([
    "Implementation Strategy:",
    analysis.explanation,
    "",
    "Marketing Strategy:",
    analysis.marketing_strategy
  ], yPosition + 10, "Strategic Implementation");

  // Page 3: Implementation Plan
  doc.addPage();
  yPosition = 20;
  yPosition = addSectionHeader("Implementation Plan & Additional Analyses", yPosition);

  // Project Details Block
  yPosition = addContentBlock([
    `Objectives: ${formData.objectives}`,
    `Timeline: ${formData.timeline}`,
    `Budget: ${formData.budget}`
  ], yPosition + 10, "Project Overview");

  // Additional Departments Analysis
  if (analysis.allAnalyses && analysis.allAnalyses.length > 1) {
    yPosition = addContentBlock(
      analysis.allAnalyses.slice(1).map(dept => 
        `${dept.department}: ${dept.function}\n` +
        `Savings: $${parseInt(dept.savings).toLocaleString()}\n` +
        `Profit Increase: ${dept.profit_increase}%`
      ),
      yPosition + 10,
      "Additional Department Recommendations"
    );
  }

  // Additional Information Block
  if (formData.additionalInfo) {
    yPosition = addContentBlock([formData.additionalInfo], yPosition + 10, "Additional Considerations");
  }

  // Footer on all pages
  const pageCount = doc.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(10);
    doc.setTextColor(128);
    doc.text(
      `Generated by ChatSites AI - Page ${i} of ${pageCount}`,
      20,
      doc.internal.pageSize.height - 10
    );
  }

  return doc;
};